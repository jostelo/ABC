---
title: "voles"
author: "Jost von Petersdorff-Campen"
date: "11 Dezember 2019"
output: html_document
---

# Preperations

```{r, message=FALSE, warning=FALSE}
library(volesModel)
library(plotly)
library(matrixStats)


data(voles_data)
voles_data$date<-voles_data$year+0.25
voles_data[which(voles_data$season=="autumn"),"date"]<-voles_data[which(voles_data$season=="autumn"),"date"]+0.5
voles_data<-voles_data[order(voles_data$date),]

```

# Plot our data 

```{r}
ax<- list(
  title = "",
  # titlefont = f1,
  showticklabels = TRUE,
  tickangle = 0
  # tickfont = f2,
  # exponentformat = "E"
)

ay<- list(
  title = "Voles Trapping Index",
  titlefont = "Open Sans",
  showticklabels = TRUE,
  tickangle = 270,
  # range = c(0.1, 0.6),
  tickfont = "Times New Roman"
  # exponentformat = "E"
)

p <- plot_ly(data = voles_data, x = ~date, y = ~popDensity,type = 'scatter', mode = 'lines+markers') %>%
  layout(xaxis = ax, yaxis = ay, showlegend = FALSE)
p

```






# Functions

## Summary Statistics

```{r}
volesStats  <- function(x, obsData, ...){

  

  if (!is.matrix(x)) x <- matrix(x, 1, length(x))
  tx <- t(x)

  X0 <- t(orderDist(tx, obsData, np=3, diff=1)) ## cubic regs coeff of ordered diffs
  X0 <- cbind(X0, t(nlar(t(x),lag=c(6, 6, 6, 1, 1), power=c(1, 2, 3, 1, 2)))) ## least square coeff
  X0 <- cbind(X0, rowMeans(x)) # mean values of Y, # of 0's
  X0 <- cbind(X0, t(slAcf(tx, max.lag = 5)))  ## autocovariances up to lag 5 (the first element is the variance)
  X0 <- cbind(X0, apply( t( abs( apply( sign( apply(x,1,diff) ), 2, diff ) )), 1, sum)/2) #Number of turning points
  X0 <- cbind(X0, rowMedians(x)) # Mean-median
  
  
  
  r=character()
  for (i in 1:3) r[i]<-paste("cubic_",i,sep = "")
  for (i in 4:8) r[i]<-paste("ols_",i-3,sep = "")
  r[9]<-"mean"
  r[10]<-"variance"
  for (i in 11:15) r[i]<-paste("autocov_",i-10,sep = "")
  r[16]<-"turning"
  r[17]<-"mean_med"
  
  colnames(X0)<-r
  return(X0)
} 

```



## Simulator

Priors: 

```{r}
voleFullPrior <- function(){
  return(c(
                               rnorm (1, 5, 1 )  ,       
                               rnorm (1, 1, 1 )   ,      
                               rexp  (1, 7 )      ,     
                               rgamma(1, 4, 40 )    ,    
                               rnorm (1, 15, 15 )    ,   
                               rnorm (1, 0.04, 0.04 ) ,  
                               rnorm (1, 1.25, 0.5 )   , 
                               runif (1, 0.5, 30 )      ,
                               runif (1, 20, 300 )) )      }
```


How does simulation work?  
1.) Set Starting values for weasle and vole abundance (e.g. 0)  
2.) Sample from the prior the parameters.   
3.) Create a whole dataset (T=90) with this priors and the starting values;  
    update weasle and vole abundance at each t  
4.) Calculate summary statistics and accept or reject parameters according to real data summary   statistics.  
5.) Do steps 2.) to 4.) M times.   
6.) For plotting: Use posterior mean of $\theta$ to draw from $Pois(\theta n_t)$ to create $Y_t$  
  
```{r}
M=1

volessimulator<-function(n0,p0,M){
  A=matrix(0,nrow = 90*12,ncol = M)
  B=matrix(0,nrow = 90*12,ncol = M)
  C=matrix(0,nrow = 90*12,ncol = M)

    for (i in 1:M){
    n=n0
    p=p0
    q=n0
    prior=voleFullPrior() 
    r=prior[1]
    e=prior[2]
    g=prior[3]
    h=prior[4]
    a=prior[5]
    d=prior[6]
    s=prior[7]
    sigma=prior[8]
    phi=prior[9]
    for (t in 2:(90*12)){
      n_temp=n[t-1]+(r*(1-e*sin(2*pi*t))*n[t-1]- r*n[t-1]^2-                                                 (g*n[t-1]^2)/(n[t-1]^2+h^2) - (a*n[t-1]*p[t-1])/(n[t-1]+d))/12
      if(is.na(n_temp)) break
      n=c(n, n_temp)
      p=c(p,p[t-1]+ (s*(1-e*sin(2*pi*t))*p[t-1]-s*(p[t-1]^2)/n[t-1])/12)             
      q=c(q,rpois(1,lambda=phi*n[t]))
    }
   if (!is.na(n_temp)){
   A[,i]=n
   B[,i]=p
   C[,i]=q
   }
  }
  A=A[, colSums(A) != 0]
  B=B[, colSums(B) != 0]
  C=C[, colSums(C) != 0]
  
  return(list(A,B,C))
}


A=volessimulator(n0=0.3,p0=0.1,M=10)
B=data.frame(A[2])
C=data.frame(A[3])

A=data.frame(A[1])

p <- plot_ly( x = 1:(90*12), y = C[,1],type = 'scatter', mode = 'lines+markers')
for (i in 2:ncol(A)){
    p<-add_trace(p,x = 1:(90*12), y = C[,i])
}

p

```


```{r}
volesStats(t(C),voles_data$)
```









```{r}
testfunction=function(n,p){
  t=1
  s=1
  return(p+ (s*(1-e*sin(2*pi*t))*p-s*(p^2)/n))  
}
x=seq(0,1,0.01)
testfunction(n=x,p=0.1)


testfunction2=function(n,p){
    (r*(1-e*sin(2*pi*t))*n- r*n^2-                                                 (g*n^2)/(n^2+h^2) - (a*n*p)/(n+d))
}

testfunction2(n=1.1,p=x)

```

