---
title: "voles"
author: "Jost von Petersdorff-Campen"
date: "06th of January, 2019"
output: html_document
---


This simulations strongly uses the methodoly of "Approximate methods for dynamic ecological models" (Wood, Fasiolo 2018). The simulator and the data can be downloaded here: 


```{r}
# install.packages("remotes")
# remotes::install_github("mfasiolo/volesModel")
```

Forge the according github-repo for more information. 


The abc algorithm is computed with the package "abc". More information for that can be retrieved from "abc: an r package for approximate bayesian computation." (Csilléry, K., François, O., and Blum, M. G., 2012)

# Preperations




```{r, message=FALSE, warning=FALSE}
library(volesModel)
library(plotly)
library(matrixStats)
library(knitr)
library(abc)

# nSteps: How many steps of calculation of the derivative
# nObs: Observed months (two per year)


# Plot the data on a time axis, which is season sensitive
data(voles_data)
set.seed(76735756)
nSteps <- 50
nObs <- 600
obsTiming <- sort(c(6 + seq(0, 12 * 44, by = 12), 9 + seq(0, 12 * 44, by = 12)))
data(voles_data)
voles_data$date<-voles_data$year+0.25
voles_data[which(voles_data$season=="autumn"),"date"]<-voles_data[which(voles_data$season=="autumn"),"date"]+0.5
voles_data<-voles_data[order(voles_data$date),]


```

# Plot our data 

```{r}
ax<- list(
  title = "",
  # titlefont = f1,
  showticklabels = TRUE,
  tickangle = 0
  # tickfont = f2,
  # exponentformat = "E"
)

ay<- list(
  title = "Voles Trapping Index",
  titlefont = "Open Sans",
  showticklabels = TRUE,
  tickangle = 270,
  # range = c(0.1, 0.6),
  tickfont = "Times New Roman"
  # exponentformat = "E"
)

p <- plot_ly(data = voles_data, x = ~date, y = ~popDensity,type = 'scatter', mode = 'lines+markers') %>%
  layout(xaxis = ax, yaxis = ay, showlegend = FALSE)
p

```








# Simulator

## Priors

...acording to Wood/Fasiolo

```{r}
voleFullPrior <- function(){
  return(c(
                               rnorm (1, 5, 1 )  ,       
                               rnorm (1, 1, 1 )   ,      
                               rexp  (1, 7 )      ,     
                               rgamma(1, 4, 40 )    ,    
                               rnorm (1, 15, 15 )    ,   
                               rnorm (1, 0.04, 0.04 ) ,  
                               rnorm (1, 1.25, 0.5 )   , 
                               runif (1, 0.5, 30 )      ,
                               runif (1, 20, 300 )) )      }
```



  
```{r}
voles_sim<-matrix(nrow=30000,ncol = 600)
param_sim<-matrix(nrow = 30000,ncol=9)
colnames(param_sim)<-c("r","e","g","h","a","d","s","sigma","phi")

# Simulate 30.000 times; save the parameters and the data

for (i in 1:30000){

  
# function to sample one time from the prior

voleFullPrior <- function(){
  return(c(
    rnorm (1, 5, 1 )  ,       
    rnorm (1, 1, 1 )   ,      
    rexp  (1, 7 )      ,     
    rgamma(1, 4, 40 )    ,    
    rnorm (1, 15, 15 )    ,   
    rnorm (1, 0.04, 0.04 ) ,  
    rnorm (1, 1.25, 0.5 )   , 
    runif (1, 0.5, 30 )      ,
    runif (1, 20, 300 )) )      }



prior=voleFullPrior() 
r=prior[1]
e=prior[2]
g=prior[3]
h=prior[4]
a=prior[5]
d=prior[6]
s=prior[7]
sigma=prior[8]
phi=prior[9]
param_sim[i,]<-prior

# Use Wood/ Fasiolos function to simulate data according to the prior

res <- volesSimulator(nObs = nObs, nsim = 1, nBurn = 120, model = "full", 
                      param = log(c(r = r, e = e, g = g, h = h,
                                    a = a, d = d, s = s, 
                                    sigmaProc = sigma, phi = phi)), 
                      nSteps = nSteps, T0 = 0,addObsNoise=TRUE)


voles_sim[i,]<-res$voles

}

```


```{r}
r=character()
for (i in 1:3) r[i]<-paste("cubic_",i,sep = "")
for (i in 4:8) r[i]<-paste("ols_",i-3,sep = "")
r[9]<-"mean"
# r[10]<-"variance"
for (i in 10:14) r[i]<-paste("autocov_",i-10,sep = "")
r[15]<-"turning"
r[16]<-"mean_med"

voles_sim_save<-voles_sim


# Lots of NA's, which is usual according to Fasiolo. Get rid of any NA's


param_sim<-param_sim[!is.nan(rowSums(voles_sim)) | !is.na(rowSums(voles_sim)),]
voles_sim<-(voles_sim[!is.nan(rowSums(voles_sim)) | !is.na(rowSums(voles_sim)),obsTiming])
stats_sim<-matrix(nrow = nrow(voles_sim),ncol=16)
for (i in 1:nrow(voles_sim)){
stats_sim[i,]<-volesStats(voles_sim[i,],extraArgs = list("obsData"=voles_sim[i,]))
}
param_sim<-param_sim[!is.nan(rowSums(stats_sim)) | !is.na(rowSums(stats_sim)),]
# voles_sim<-voles_sim[!is.nan(rowSums(stats_sim)) | !is.na(rowSums(stats_sim)),]
stats_sim<-stats_sim[!is.nan(rowSums(stats_sim)) | !is.na(rowSums(stats_sim)),]
colnames(stats_sim)<-r
```


```{r}
# Fit  our data to the observed by mutliplying it with 10. See Fasiolo/ Wood...

data(voles_data)
data <- round(voles_data$popDensity*10)
stat_obs<-volesStats(voles_data$popDensity*10,extraArgs = list("obsData"=data))
```


Plot some simulated data
```{r}

ay1<-list(
  title = "Voles",
  # titlefont = f1,
  showticklabels = TRUE,
  tickangle = 0
  # tickfont = f2,
  # exponentformat = "E"
)

ax1<-list(
  title = "Time",
  # titlefont = f1,
  showticklabels = TRUE,
  tickangle = 0
  # tickfont = f2,
  # exponentformat = "E"
)

p <- plot_ly( x = 1:90, y = voles_sim[1,],type = 'scatter', mode = 'lines',name = "simulations",line=list(color="grey")) 
for (i in 2:3){
    p<-add_trace(p,x = 1:90, y = voles_sim[i,],showlegend=FALSE,opacity=i/6)
}

p<-add_trace(p,x = 1:90, y = data,name="real data",line=list(color="black")) %>%
  layout(yaxis=ay1,xaxis=ax1)


p
```



## Rejection algorithm

```{r}
# Leave out the cubic regression, since it leads to huge problem of overflow, which makes a lot of simulations unuseable.

abc_rej<-abc(target=stat_obs[-(1:3)], param=param_sim, sumstat=stats_sim[,-(1:3)], tol=.1, method =
"rejection")


param_dens<-abc_rej[["unadj.values"]]
# param_dens<-sel_PARAM_TEST

colnames(param_dens)<-colnames(param_sim)



ay1<-list(
  title = "",
  # titlefont = f1,
  showticklabels = TRUE,
  tickangle = 0
  # tickfont = f2,
  # exponentformat = "E"
)
ay2<-list(
  title = "",
  # titlefont = f1,
  showticklabels = TRUE,
  tickangle = 0
  # tickfont = f2,
  # exponentformat = "E"
)

colnames(param_sim)<-c("r","e","g","h","a","d","s","sigma","phi")

# Plot the appr. posterior distributions of the parameter

x<-seq (0, 10, 0.1 )
y<-dnorm (x, 5, 1 )  
p1 <- plot_ly() %>%
  add_histogram(param_dens[,"r"],histnorm='probability density',name="density ABC") %>%
  add_trace(x=x,y=y,yaxis="ay2",mode="lines",name="prior",dash = 'dash') %>%
  add_segments(x = 4.85, xend = 4.85, y = 0, yend = max(y)+0.3, name="Posterior Mean of SL (Wood/ Fasiolo)") %>%
  add_segments(x = mean(param_dens[,"r"]), xend = mean(param_dens[,"r"]), y = 0, yend = max(y)+0.3, name="Posterior Mean") %>%
  layout(showlegend = FALSE,title="")

p1

x<-seq (0, 4, 0.1 )
y<-dnorm (x, 1, 1 ) 
p2 <- plot_ly() %>%
  add_histogram(param_dens[,"e"],histnorm='probability density',name="density ABC") %>%
  add_trace(x=x,y=y,yaxis="ay2",mode="lines",name="prior",dash = 'dash') %>%
  add_segments(x = 0.78, xend = 0.78, y = 0, yend = max(y)+0.4, name="Posterior Mean of SL (Wood/ Fasiolo)") %>%
  add_segments(x = mean(param_dens[,"e"]), xend = mean(param_dens[,"e"]), y = 0, yend = max(y)+0.4, name="Posterior Mean") %>%
  layout(showlegend = FALSE,title="")

p2 


x<-seq (0, 0.9, 0.01 )
y<-   dexp  (x, 7 )          
p3 <- plot_ly() %>%
  add_histogram(param_dens[,"g"],histnorm='probability density',name="density ABC") %>%
  add_trace(x=x,y=y,yaxis="ay2",mode="lines",name="prior",dash = 'dash') %>%
  add_segments(x = 0.11, xend = 0.11, y = 0, yend = max(y)+2, name="Posterior Mean of SL (Wood/ Fasiolo)") %>%
  add_segments(x = mean(param_dens[,"g"]), xend = mean(param_dens[,"g"]), y = 0, yend = max(y)+2, name="Posterior Mean") %>%
  layout(showlegend = FALSE,title="")


p3




x<-seq (0, 0.5, 0.01 )
y<-    dgamma(x, 4, 40 )        
p34 <- plot_ly() %>%
  add_histogram(param_dens[,"h"],histnorm='probability density',name="density ABC") %>%
  add_trace(x=x,y=y,yaxis="ay2",mode="lines",name="prior",dash = 'dash') %>%
  add_segments(x = 0.1, xend = 0.1, y = 0, yend = max(y)+1, name="Posterior Mean of SL (Wood/ Fasiolo)") %>%
  add_segments(x = mean(param_dens[,"h"]), xend = mean(param_dens[,"h"]), y = 0, yend = max(y)+1, name="Posterior Mean") %>%
  layout(showlegend = FALSE,title="")


p34

x<-seq (0, 50, 0.1 )
y<- dnorm (x, 15, 15 )       
p4 <- plot_ly() %>%
  add_histogram(param_dens[,"a"],histnorm='probability density',name="density ABC") %>%
  add_trace(x=x,y=y,yaxis="ay2",mode="lines",name="prior",dash = 'dash') %>%
  add_segments(x = 8, xend = 8, y = 0, yend = max(y)+0.03, name="Posterior Mean of SL (Wood/ Fasiolo)") %>%
  add_segments(x = mean(param_dens[,"a"]), xend = mean(param_dens[,"a"]), y = 0, yend = max(y)+0.03, name="Posterior Mean") %>%
  layout(showlegend = FALSE,title="")


p4




x<-seq (0, 0.2, 0.001 )
y<-    dnorm (x, 0.04, 0.04 )   
         
p5 <- plot_ly() %>%
  add_histogram(param_dens[,"d"],histnorm='probability density',name="density ABC") %>%
  add_trace(x=x,y=y,yaxis="ay2",mode="lines",name="prior",dash = 'dash') %>%
  add_segments(x = 0.07, xend = 0.07, y = 0, yend = max(y)+5, name="Posterior Mean of SL (Wood/ Fasiolo)") %>%
  add_segments(x = mean(param_dens[,"d"]), xend = mean(param_dens[,"d"]), y = 0, yend = max(y)+5, name="Posterior Mean") %>%
  layout(showlegend = FALSE,title="")


p5




x<-seq (0, 3, 0.01 )
y<-dnorm (x, 1.25, 0.5 )    
          
p6 <- plot_ly() %>%
  add_histogram(param_dens[,"s"],histnorm='probability density',name="density ABC") %>%
  add_trace(x=x,y=y,yaxis="ay2",mode="lines",name="prior",dash = 'dash') %>%
  add_segments(x = 1.04, xend = 1.04, y = 0, yend = max(y)+0.5, name="Posterior Mean of SL (Wood/ Fasiolo)") %>%
  add_segments(x = mean(param_dens[,"s"]), xend = mean(param_dens[,"s"]), y = 0, yend = max(y)+0.5, name="Posterior Mean") %>%
  layout(showlegend = FALSE,title="")


p6



x<-seq (0.5, 30, 0.1 )
y<-   dunif (x, 0.5, 30 )          
p7 <- plot_ly() %>%
  add_histogram(param_dens[,"sigma"],histnorm='probability density',name="density ABC") %>%
  add_trace(x=x,y=y,yaxis="ay2",mode="lines",name="prior",dash = 'dash') %>%
  add_segments(x = 8.4, xend = 8.4, y = 0, yend = max(y)+0.02, name="Posterior Mean of SL (Wood/ Fasiolo)") %>%
  add_segments(x = mean(param_dens[,"sigma"]), xend = mean(param_dens[,"sigma"]), y = 0, yend = max(y)+0.02, name="Posterior Mean")  %>%
  layout(showlegend = FALSE,title="")


p7



x<-seq (20, 300,1 )
y<-   dunif (x, 20, 300 )          
p8 <- plot_ly() %>%
  add_histogram(param_dens[,"phi"],histnorm='probability density',name="density ABC") %>%
  add_trace(x=x,y=y,yaxis="ay2",mode="lines",name="Prior",dash = 'dot') %>%
  add_segments(x = 270.5, xend = 270.5, y = 0, yend = max(y)+0.004, name="Posterior Mean of SL (Wood/ Fasiolo)") %>%
  add_segments(x = mean(param_dens[,"phi"]), xend = mean(param_dens[,"phi"]), y = 0, yend = max(y)+0.004, name="Posterior Mean") %>%
  layout(showlegend = FALSE,title="")



p8



```




## Local Linear Regression


```{r}
# same logic as above

abc_rej_lin<-abc(target=stat_obs[-(1:3)], param=param_sim, sumstat=stats_sim[,-(1:3)], tol=0.1, method =
"loclinear") 
param_dens_lin<-abc_rej_lin[["adj.values"]][abc_rej_lin[["adj.values"]][,8]>=0 , ]
colnames(param_dens_lin)<-colnames(param_sim)



ay1<-list(
  title = "",
  # titlefont = f1,
  showticklabels = TRUE,
  tickangle = 0
  # tickfont = f2,
  # exponentformat = "E"
)
ay2<-list(
  title = "",
  # titlefont = f1,
  showticklabels = TRUE,
  tickangle = 0
  # tickfont = f2,
  # exponentformat = "E"
)

colnames(param_sim)<-c("r","e","g","h","a","d","s","sigma","phi")


x<-seq (0, 10, 0.1 )
y<-dnorm (x, 5, 1 )  
p1 <- plot_ly() %>%
  add_histogram(param_dens_lin[,"r"],histnorm='probability density',name="density ABC") %>%
  add_trace(x=x,y=y,yaxis="ay2",mode="lines",name="prior",dash = 'dash') %>%
  add_segments(x = 4.85, xend = 4.85, y = 0, yend = max(y)+0.3, name="Posterior Mean of SL (Wood/ Fasiolo)") %>%
  add_segments(x = mean(param_dens_lin[,"r"]), xend = mean(param_dens_lin[,"r"]), y = 0, yend = max(y)+0.3, name="Posterior Mean") %>%
  layout(showlegend = FALSE,title="")

p1

x<-seq (0, 4, 0.1 )
y<-dnorm (x, 1, 1 ) 
p2 <- plot_ly() %>%
  add_histogram(param_dens_lin[,"e"],histnorm='probability density',name="density ABC") %>%
  add_trace(x=x,y=y,yaxis="ay2",mode="lines",name="prior",dash = 'dash') %>%
  add_segments(x = 0.78, xend = 0.78, y = 0, yend = max(y)+3, name="Posterior Mean of SL (Wood/ Fasiolo)") %>%
  add_segments(x = mean(param_dens_lin[,"e"]), xend = mean(param_dens_lin[,"e"]), y = 0, yend = max(y)+3, name="Posterior Mean") %>%
  layout(showlegend = FALSE,title="")

p2 


x<-seq (0, 0.9, 0.01 )
y<-   dexp  (x, 7 )          
p3 <- plot_ly() %>%
  add_histogram(param_dens_lin[,"g"],histnorm='probability density',name="density ABC") %>%
  add_trace(x=x,y=y,yaxis="ay2",mode="lines",name="prior",dash = 'dash') %>%
  add_segments(x = 0.11, xend = 0.11, y = 0, yend = max(y)+2, name="Posterior Mean of SL (Wood/ Fasiolo)") %>%
  add_segments(x = mean(param_dens_lin[,"g"]), xend = mean(param_dens_lin[,"g"]), y = 0, yend = max(y)+2, name="Posterior Mean") %>%
  layout(showlegend = FALSE,title="")


p3




x<-seq (0, 0.5, 0.01 )
y<-    dgamma(x, 4, 40 )        
p34 <- plot_ly() %>%
  add_histogram(param_dens_lin[,"h"],histnorm='probability density',name="density ABC") %>%
  add_trace(x=x,y=y,yaxis="ay2",mode="lines",name="prior",dash = 'dash') %>%
  add_segments(x = 0.1, xend = 0.1, y = 0, yend = max(y)+1, name="Posterior Mean of SL (Wood/ Fasiolo)") %>%
  add_segments(x = mean(param_dens_lin[,"h"]), xend = mean(param_dens_lin[,"h"]), y = 0, yend = max(y)+1, name="Posterior Mean") %>%
  layout(showlegend = FALSE,title="")


p34

x<-seq (0, 50, 0.1 )
y<- dnorm (x, 15, 15 )       
p4 <- plot_ly() %>%
  add_histogram(param_dens_lin[,"a"],histnorm='probability density',name="density ABC") %>%
  add_trace(x=x,y=y,yaxis="ay2",mode="lines",name="prior",dash = 'dash') %>%
  add_segments(x = 8, xend = 8, y = 0, yend = max(y)+0.23, name="Posterior Mean of SL (Wood/ Fasiolo)") %>%
  add_segments(x = mean(param_dens_lin[,"a"]), xend = mean(param_dens_lin[,"a"]), y = 0, yend = max(y)+0.23, name="Posterior Mean") %>%
  layout(showlegend = FALSE,title="")


p4




x<-seq (0, 0.2, 0.001 )
y<-    dnorm (x, 0.04, 0.04 )   
         
p5 <- plot_ly() %>%
  add_histogram(param_dens_lin[,"d"],histnorm='probability density',name="density ABC") %>%
  add_trace(x=x,y=y,yaxis="ay2",mode="lines",name="prior",dash = 'dash') %>%
  add_segments(x = 0.07, xend = 0.07, y = 0, yend = max(y)+8, name="Posterior Mean of SL (Wood/ Fasiolo)") %>%
  add_segments(x = mean(param_dens_lin[,"d"]), xend = mean(param_dens_lin[,"d"]), y = 0, yend = max(y)+8, name="Posterior Mean") %>%
  layout(showlegend = FALSE,title="")


p5




x<-seq (0, 3, 0.01 )
y<-dnorm (x, 1.25, 0.5 )    
          
p6 <- plot_ly() %>%
  add_histogram(param_dens_lin[,"s"],histnorm='probability density',name="density ABC") %>%
  add_trace(x=x,y=y,yaxis="ay2",mode="lines",name="prior",dash = 'dash') %>%
  add_segments(x = 1.04, xend = 1.04, y = 0, yend = max(y)+1.5, name="Posterior Mean of SL (Wood/ Fasiolo)") %>%
  add_segments(x = mean(param_dens_lin[,"s"]), xend = mean(param_dens_lin[,"s"]), y = 0, yend = max(y)+1.5, name="Posterior Mean") %>%
  layout(showlegend = FALSE,title="")


p6



x<-seq (0.5, 30, 0.1 )
y<-   dunif (x, 0.5, 30 )          
p7 <- plot_ly() %>%
  add_histogram(param_dens_lin[,"sigma"],histnorm='probability density',name="density ABC") %>%
  add_trace(x=x,y=y,yaxis="ay2",mode="lines",name="prior",dash = 'dash') %>%
  add_segments(x = 8.4, xend = 8.4, y = 0, yend = max(y)+0.07, name="Posterior Mean of SL (Wood/ Fasiolo)") %>%
  add_segments(x = mean(param_dens_lin[,"sigma"]), xend = mean(param_dens_lin[,"sigma"]), y = 0, yend = max(y)+0.07, name="Posterior Mean")  %>%
  layout(showlegend = FALSE,title="")


p7



x<-seq (20, 300,1 )
y<-   dunif (x, 20, 300 )          
p8 <- plot_ly() %>%
  add_histogram(param_dens_lin[,"phi"],histnorm='probability density',name="density ABC") %>%
  add_trace(x=x,y=y,yaxis="ay2",mode="lines",name="Prior",dash = 'dot') %>%
  add_segments(x = 270.5, xend = 270.5, y = 0, yend = max(y)+0.007, name="Posterior Mean of SL (Wood/ Fasiolo)") %>%
  add_segments(x = mean(param_dens_lin[,"phi"]), xend = mean(param_dens_lin[,"phi"]), y = 0, yend = max(y)+0.007, name="Posterior Mean") %>%
  layout(showlegend = FALSE,title="")



p8



```

## Comparison Plots

```{r}
x<-seq (20, 300,30 )
y<-   dunif (x, 20, 300 )          
p<- plot_ly(alpha=0.8) %>%
  add_histogram(param_dens_lin[,"phi"],histnorm='probability density',name="density ABC Regression") %>%
  add_histogram(param_dens[,"phi"],histnorm='probability density',name="density ABC Rejaction") %>%
  add_trace(x=x,y=y,yaxis="ay2",mode="lines",name="Prior",dash = 'dot') %>%
  add_segments(x = 270.5, xend = 270.5, y = 0, yend = max(y)+0.007, name="Posterior Mean of SL (Wood/ Fasiolo)") %>%
  add_segments(x = mean(param_dens_lin[,"phi"]), xend = mean(param_dens_lin[,"phi"]), y = 0, yend = max(y)+0.007, name="Posterior Mean") %>%
  layout(showlegend = TRUE,title="",barmode = "overlay")



p



x<-seq (0, 4, 0.1 )
y<-dnorm (x, 1, 1 )          
p<- plot_ly(alpha=0.8) %>%
  add_histogram(param_dens_lin[,"e"],histnorm='probability density',name="density ABC Regression") %>%
  add_histogram(param_dens[,"e"],histnorm='probability density',name="density ABC Rejaction") %>%
  add_trace(x=x,y=y,yaxis="ay2",mode="lines",name="Prior",dash = 'dot') %>%
  add_segments(x = 0.78, xend = 0.78, y = 0, yend = max(y)+3, name="Posterior Mean of SL (Wood/ Fasiolo)") %>%
  add_segments(x = mean(param_dens_lin[,"e"]), xend = mean(param_dens_lin[,"e"]), y = 0, yend = max(y)+3, name="Posterior Mean") %>%
  layout(showlegend = TRUE,title="",barmode = "overlay")



p
```







# Test accuracy

## Rejection

```{r}

# assume pseudo true parameters

res_true<-volesSimulator(nObs = nObs, nsim = 20, nBurn = 120, model = "full", 
                      param = log(c(r = 5, e = 1.58, g = 0.1, h = 0.12,
                                    a = 7.6, d = 0.6, s = 0.9, 
                                    sigmaProc = 1.5, phi = 150)),
                      nSteps = nSteps, T0 = 0,addObsNoise=TRUE)



true<-res_true[[1]][,obsTiming]
true_stats<-matrix(nrow = 15,ncol=16)

post_mean<-matrix(nrow = 15,ncol = 9)

# create 15 pseudo observed data sets and run on each the abc algorithm


for (i in 1:15){
  true_stats[i,]<-volesStats(true[i,],extraArgs = list("obsData"=data))
  
  
  voles_sim_test<-matrix(nrow=10000,ncol = 600)
  param_sim_test<-matrix(nrow = 10000,ncol=9)
  colnames(param_sim_test)<-c("r","e","g","h","a","d","s","sigma","phi")
  
  
  for (j in 1:10000){
  
    
    prior=voleFullPrior() 
    r=prior[1]
    e=prior[2]
    g=prior[3]
    h=prior[4]
    a=prior[5]
    d=prior[6]
    s=prior[7]
    sigma=prior[8]
    phi=prior[9]
    param_sim_test[j,]<-prior
    
    res <- volesSimulator(nObs = nObs, nsim = 1, nBurn = 120, model = "full", 
                          param = log(c(r = r, e = e, g = g, h = h,
                                        a = a, d = d, s = s, 
                                        sigmaProc = sigma, phi = phi)), 
                          nSteps = nSteps, T0 = 0,addObsNoise=TRUE)
    
    
    # test<-res$voles[obsTiming]
    voles_sim_test[j,]<-res$voles

  }
  
  param_sim_test<-param_sim_test[!is.nan(rowSums(voles_sim_test)) | !is.na(rowSums(voles_sim_test)),]
  voles_sim_test<-(voles_sim_test[!is.nan(rowSums(voles_sim_test)) | !is.na(rowSums(voles_sim_test)),obsTiming])
  stats_sim_test<-matrix(nrow = nrow(voles_sim_test),ncol=16)
  for (k in 1:nrow(voles_sim_test)){
  stats_sim_test[k,]<-volesStats(voles_sim_test[k,],extraArgs = list("obsData"=voles_sim_test[k,]))
  }
  param_sim_test<-param_sim_test[!is.nan(rowSums(stats_sim_test)) | !is.na(rowSums(stats_sim_test)),]
  # voles_sim_test<-voles_sim_test[!is.nan(rowSums(stats_sim_test)) | !is.na(rowSums(stats_sim_test)),]
  stats_sim_test<-stats_sim_test[!is.nan(rowSums(stats_sim_test)) | !is.na(rowSums(stats_sim_test)),]
  
  
  abc<-abc(target=true_stats[i,-(1:3)], param=param_sim_test, sumstat=stats_sim_test[,-(1:3)], tol=.1, method =
"rejection")
  
  
  assign(paste("unad_test",i,"_",j,sep = ""),abc[["unadj.values"]])
  post_mean[i,]<-colMeans(abc[["unadj.values"]])
  
  
}

# Calculate the root mean squared error

true_val<-c(r = 5, e = 1.58, g = 0.1, h = 0.12,
                                    a = 7.6, d = 0.6, s = 0.9, 
                                    sigmaProc = 1.5, phi = 150)


RMSE<-rep(0,9)

for (j in 1:9){   
for (i in 1:nrow(post_mean)){ 
  RMSE[j]<-RMSE[j]+(post_mean[i,j]-true_val[j])^2
}
}
RMSE<-(RMSE/nrow(post_mean))^0.5
table(round(RMSE,2))
```



## Regression

```{r}
# Same Logic as above

res_true<-volesSimulator(nObs = nObs, nsim = 20, nBurn = 120, model = "full", 
                      param = log(c(r = 5, e = 1.58, g = 0.1, h = 0.12,
                                    a = 7.6, d = 0.6, s = 0.9, 
                                    sigmaProc = 1.5, phi = 150)),
                      nSteps = nSteps, T0 = 0,addObsNoise=TRUE)



true<-res_true[[1]][,obsTiming]
true_stats<-matrix(nrow = 15,ncol=16)

post_mean_reg<-matrix(nrow = 15,ncol = 9)


for (i in 1:15){
  true_stats[i,]<-volesStats(true[i,],extraArgs = list("obsData"=data))
  
  
  voles_sim_test_reg<-matrix(nrow=10000,ncol = 600)
  param_sim_test_reg<-matrix(nrow = 10000,ncol=9)
  colnames(param_sim_test_reg)<-c("r","e","g","h","a","d","s","sigma","phi")
  
  
  for (j in 1:10000){
  
    
    prior=voleFullPrior() 
    r=prior[1]
    e=prior[2]
    g=prior[3]
    h=prior[4]
    a=prior[5]
    d=prior[6]
    s=prior[7]
    sigma=prior[8]
    phi=prior[9]
    param_sim_test_reg[j,]<-prior
    
    res <- volesSimulator(nObs = nObs, nsim = 1, nBurn = 120, model = "full", 
                          param = log(c(r = r, e = e, g = g, h = h,
                                        a = a, d = d, s = s, 
                                        sigmaProc = sigma, phi = phi)), 
                          nSteps = nSteps, T0 = 0,addObsNoise=TRUE)
    
    
    voles_sim_test_reg[j,]<-res$voles

  }
  
  param_sim_test_reg<-param_sim_test_reg[!is.nan(rowSums(voles_sim_test_reg)) | !is.na(rowSums(voles_sim_test_reg)),]
  voles_sim_test_reg<-(voles_sim_test_reg[!is.nan(rowSums(voles_sim_test_reg)) | !is.na(rowSums(voles_sim_test_reg)),obsTiming])
  stats_sim_test_reg<-matrix(nrow = nrow(voles_sim_test_reg),ncol=16)
  for (k in 1:nrow(voles_sim_test_reg)){
  stats_sim_test_reg[k,]<-volesStats(voles_sim_test_reg[k,],extraArgs = list("obsData"=voles_sim_test_reg[k,]))
  }
  param_sim_test_reg<-param_sim_test_reg[!is.nan(rowSums(stats_sim_test_reg)) | !is.na(rowSums(stats_sim_test_reg)),]

  stats_sim_test_reg<-stats_sim_test_reg[!is.nan(rowSums(stats_sim_test_reg)) | !is.na(rowSums(stats_sim_test_reg)),]
  
  
  abc<-abc(target=true_stats[i,-(1:3)], param=param_sim_test_reg, sumstat=stats_sim_test_reg[,-(1:3)], tol=.1, method =
"loclinear")
  
  assign(paste("unad_reg_test",i,"_",j,sep = ""),abc[["unadj.values"]])
  
  post_mean_reg[i,]<-colMeans(abc[["unadj.values"]])
  
  
}

true_val<-c(r =5, e = 1.58, g = 0.1, h = 0.12,
                                    a = 7.6, d = 0.6, s = 0.9, 
                                    sigmaProc = 1.5, phi = 150)


RMSE_reg<-rep(0,9)

for (j in 1:9){   
for (i in 1:nrow(post_mean_reg)){ 
  RMSE_reg[j]<-RMSE_reg[j]+(post_mean_reg[i,j]-true_val[j])^2
  print(RMSE_reg[j])
}
}
RMSE_reg<-(RMSE_reg/nrow(post_mean_reg))^0.5
(round(RMSE_reg,2))

```

